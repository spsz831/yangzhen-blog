# YangZhen博客网站 - 免费部署指南

本指南将帮助您将YangZhen博客网站免费部署到云端，并优化在中国的访问速度。

## 免费部署架构

- **数据库**: Supabase (免费PostgreSQL，500MB存储)
- **后端**: Railway (免费500小时/月)
- **前端**: Vercel (免费CDN，在中国访问良好)

## 第一步：设置Supabase数据库

### 1. 创建Supabase账户
1. 访问 [supabase.com](https://supabase.com)
2. 点击 "Start your project"
3. 使用GitHub账户登录
4. 创建新项目：
   - Project name: `yangzhen-blog`
   - Database Password: 生成强密码并保存
   - Region: 选择 `Southeast Asia (Singapore)` (距离中国最近)

### 2. 获取数据库连接信息
项目创建后，进入项目面板：
1. 点击 Settings → Database
2. 记录以下信息：
   - `Host`
   - `Database name`
   - `Port`
   - `User`
   - `Password`

### 3. 构建数据库连接字符串
格式：`postgresql://[user]:[password]@[host]:[port]/[database]?pgbouncer=true`

示例：
```
DATABASE_URL="postgresql://postgres:your_password@db.xxx.supabase.co:5432/postgres?pgbouncer=true"
```

### 4. 运行数据库迁移
在本地项目中：
```bash
cd E:\WorkSpace\个人博客网站YangZhen\backend
npm install
# 使用Supabase数据库URL替换.env中的DATABASE_URL
npx prisma db push
npx prisma db seed
```

## 第二步：部署后端到Railway

### 1. 准备Railway部署
1. 访问 [railway.app](https://railway.app)
2. 使用GitHub账户登录
3. 点击 "New Project"
4. 选择 "Deploy from GitHub repo"
5. 选择您的博客项目仓库

### 2. 配置Railway项目
1. 选择后端服务：
   - Root Directory: `backend`
   - Build Command: `npm run build`
   - Start Command: `npm start`

### 3. 设置环境变量
在Railway项目设置中添加：
```bash
DATABASE_URL=postgresql://postgres:your_password@db.xxx.supabase.co:5432/postgres?pgbouncer=true
JWT_SECRET=your_jwt_secret_here
NODE_ENV=production
PORT=3001
```

### 4. 部署验证
- Railway会自动部署并提供一个URL
- 记录这个URL，格式如：`https://your-app.railway.app`

## 第三步：部署前端到Vercel

### 1. 准备Vercel部署
1. 访问 [vercel.com](https://vercel.com)
2. 使用GitHub账户登录
3. 点击 "New Project"
4. 选择您的博客项目仓库

### 2. 配置Vercel项目
1. Framework Preset: `Next.js`
2. Root Directory: `frontend`
3. Build Command: `npm run build`
4. Output Directory: `.next`

### 3. 设置环境变量
在Vercel项目设置中添加：
```bash
NEXT_PUBLIC_API_URL=https://your-app.railway.app
NEXT_PUBLIC_SITE_URL=https://your-app.vercel.app
```

### 4. 优化中国访问
在`next.config.js`中添加：
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    domains: ['your-app.railway.app'],
  },
  // 启用静态导出优化
  output: 'standalone',
  // CDN优化
  assetPrefix: process.env.NODE_ENV === 'production' ? '/static' : '',
}

module.exports = nextConfig
```

## 第四步：域名和SSL配置（可选）

### 1. 自定义域名
- Vercel: 项目设置 → Domains → 添加域名
- 添加DNS记录：`CNAME www your-app.vercel.app`

### 2. 更新环境变量
使用自定义域名更新所有环境变量中的URL。

## 第五步：性能优化

### 1. Vercel边缘缓存
在`frontend/src/app/layout.tsx`中添加：
```typescript
export const metadata = {
  // ... 现有metadata
  other: {
    'cache-control': 'public, max-age=31536000, immutable',
  },
}
```

### 2. API响应缓存
在Railway后端添加缓存头：
```javascript
app.use((req, res, next) => {
  res.header('Cache-Control', 'public, max-age=300'); // 5分钟缓存
  next();
});
```

## 快速部署命令

### 本地测试部署配置
```bash
# 1. 克隆并进入项目目录
cd E:\WorkSpace\个人博客网站YangZhen

# 2. 安装后端依赖
cd backend
npm install

# 3. 配置数据库 (使用Supabase URL)
# 编辑 .env 文件，添加 DATABASE_URL
npx prisma generate
npx prisma db push
npx prisma db seed

# 4. 测试后端构建
npm run build
npm start

# 5. 安装前端依赖
cd ../frontend
npm install

# 6. 测试前端构建
npm run build
npm start
```

### GitHub仓库准备
```bash
# 如果还没有git仓库，初始化一个
git init
git add .
git commit -m "Initial commit: YangZhen blog project"

# 推送到GitHub (需要先在GitHub创建仓库)
git remote add origin https://github.com/yourusername/yangzhen-blog.git
git push -u origin main
```

## 部署检查清单

- [ ] Supabase数据库创建并迁移完成
- [ ] Railway后端部署成功
- [ ] Vercel前端部署成功
- [ ] 环境变量配置正确
- [ ] 数据库种子数据导入
- [ ] 网站功能测试通过
- [ ] 在中国网络环境下访问测试

## 费用说明

**完全免费使用限额：**
- Supabase: 500MB数据库，50MB文件存储
- Railway: 每月500小时运行时间，1GB RAM
- Vercel: 100GB带宽，无限静态站点

这些限额对于个人博客来说完全足够使用。

## 故障排除

### 常见问题
1. **数据库连接失败**: 检查DATABASE_URL格式和网络权限
2. **Railway部署失败**: 确认build命令和start命令正确
3. **Vercel构建错误**: 检查前端代码语法和依赖项
4. **中国访问缓慢**: 启用Vercel的边缘缓存和静态资源优化

### 监控工具
- Railway: 内置日志和监控
- Vercel: Analytics面板
- Supabase: Dashboard监控

部署完成后，您的博客将拥有全球CDN加速，在中国访问速度良好，且完全免费运行！